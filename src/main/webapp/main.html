<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <title>layui在线调试</title>
    <link rel="stylesheet" href="layui/css/layui.css" media="all">
</head>
<body>

<table class="layui-hide" id="video" lay-filter="test"></table>

<script type="text/html" id="barDemo">
    <button class="layui-btn layui-btn-primary layui-btn-xs" lay-event="detail">查看</button>
    <button class="layui-btn layui-btn-xs" lay-event="edit">编辑</button>
    <button class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</button>
</script>

<script type="text/javascript" src="layui/layui.js"></script>
<script type="text/javascript">
    layui.use(['table', 'form', 'layer'], function(){
        var table = layui.table, //表格
            form = layui.form,
            $ = layui.jquery,
            layer = layui.layer

        //执行一个 table 实例
        table.render({
            elem: '#video'
            ,height: 420
            ,url: 'http://localhost:8080/trill/videos/getResult' //数据接口
            ,parseData: function(res){ //res 即为原始返回的数据
                return {
                    "code": res.status, //解析接口状态
                    "msg": res.message, //解析提示文本
                    "count": res.total, //解析数据长度
                    "data": res.data //解析数据列表
                };
            }
            ,title: '用户表'
            ,page: true //开启分页
            ,toolbar: 'default' //开启工具栏，此处显示默认图标，可以自定义模板，详见文档
            ,cols: [
                [ //表头
                {type: 'checkbox', fixed: 'left'}
                ,{field: 'id', title: 'ID', sort:true, fixed: 'left'}
                ,{field: 'nickname', title: '昵称'}
                ,{field: 'videoDesc', edit: 'text', title: '视频描述'}
                ,{field: 'videoPath', edit: 'text', title: '视频地址'}
                ,{field: 'likeCounts', edit: 'text', title: '点赞数', sort:true}
                ,{field: 'createTime', title: '发布时间', sort:true}
                //,{field: 'status', title: '状态'}
                //,{title: '状态2', align: 'center', templet: '#lockDemo'}
                ,{field: 'status', title: '状态'
                    ,templet: function(d) {
                        var vid = d.id;
                        if (d.status == 1) {
                            return '<input type="checkbox" name="status" value='+vid+' lay-skin="switch" lay-text="发布|下线" lay-filter="statusDemo" checked>'
                        } else if (d.status == 0) {
                            return '<input type="checkbox" name="status" value='+vid+' lay-skin="switch" lay-text="发布|下线" lay-filter="statusDemo">'
                        }
                    }
                }
                ,{fixed: 'right', align:'center', toolbar: '#barDemo'}
                ]
            ]
        });

        form.on('switch(statusDemo)', function(obj){
            var ch = obj.elem.checked;
            var newStatus = (ch == true) ? 1 : 0;
            $.ajax({
                type: 'post',
                url: 'http://localhost:8080/trill/videos/update',
                data: {
                    "field": 'status',
                    'vid' : obj.elem.value,
                    'value' : newStatus
                },
                dataType: 'json',
                success: function (res){
                    layer.msg(res.message/*, {}, function (){}*/)
                }
            })
        });

        //监听单元格编辑
        table.on('edit(test)', function(obj){
            var value = obj.value //得到修改后的值
                ,data = obj.data //得到所在行所有键值
                ,field = obj.field; //得到字段


            $.ajax({
                type: 'post',
                url: 'http://localhost:8080/trill/videos/update',
                data:{
                    "vid": data.id,
                    "field": field,
                    "value": value
                },
                dataType: 'json',
                success: function (res){
                    layer.msg(res.message)
                }
            })
        });

        //监听工具条
        table.on('tool(test)', function(obj){ //注：tool 是工具条事件名，test 是 table 原始容器的属性 lay-filter="对应的值"
            var data = obj.data; //获得当前行数据
            var layEvent = obj.event; //获得 lay-event 对应的值（也可以是表头的 event 参数对应的值）
            var tr = obj.tr; //获得当前行 tr 的 DOM 对象（如果有的话）

            if(layEvent === 'detail'){ //查看
                $.ajax({
                    type: 'get',
                    url: 'http://localhost:8080/trill/videos/getVideoById?id='+data.id,
                    dataType: 'json',
                    success: function (res){
                        layer.open({
                            type: 2,
                            title: 'video information',
                            area: ['90%', '90%'],
                            content: 'http://localhost:8080/trill/videoInfo.html',
                            success: function(layero, index){
                                var body = layer.getChildFrame('body', index);
                                var iframeWin = window[layero.find('iframe')[0]['name']]; //得到iframe页的窗口对象，执行iframe页的方法：iframeWin.method();
                                body.find('id').val('Hi，我是从父页来的');
                                body.find('videoDesc').val('Hi，我是从父页来的');
                                body.find('videoPath').val('Hi，我是从父页来的');
                                body.find('likeCounts').val('Hi，我是从父页来的');
                                body.find('createDate').val('Hi，我是从父页来的');
                                body.find('status').val('Hi，我是从父页来的');
                            }
                        });
                    }
                })
            } else if(layEvent === 'del'){
                layer.confirm('真的删除行么', function(index){
                    obj.del(); //删除对应行（tr）的DOM结构，并更新缓存
                    layer.close(index);
                    //向服务端发送删除指令
                    $.ajax({
                        type: 'post',
                        url: 'http://localhost:8080/trill/videos/deleteById',
                        data:{
                            "vid": data.id
                        },
                        dataType: 'json',
                        success: function (res){
                            layer.msg(res.message)
                        }
                    })
                });
            } else if(layEvent === 'edit'){
                //do something

                //同步更新缓存对应的值
                obj.update({
                    username: '123'
                    ,title: 'xxx'
                });
            } else if(layEvent === 'LAYTABLE_TIPS'){
                layer.alert('Hi，头部工具栏扩展的右侧图标。');
            }
        });

    });
</script>
</body>
</html>